/* graphics.js
   Graphics object handles all rendering.
*/
(function(a){var d,c=a.mapster,e=c.utils;function b(g,f,k){var j=g,i=j.map_data,h=k.isMask;
a.each(f.areas(),function(m,l){k.isMask=h||(l.nohref&&i.options.noHrefIsMask);j.addShape(l,k);
});k.isMask=h;}c.Graphics=function(f){var g=this;g.active=false;g.canvas=null;g.width=0;
g.height=0;g.shapes=[];g.masks=[];g.map_data=f;};d=c.Graphics.prototype={constructor:c.Graphics,begin:function(g,h){var f=a(g);
this.elementName=h;this.canvas=g;this.width=f.width();this.height=f.height();this.shapes=[];
this.masks=[];this.active=true;},addShape:function(g,h){var f=h.isMask?this.masks:this.shapes;
f.push({mapArea:g,options:h});},createVisibleCanvas:function(f){return a(this.createCanvasFor(f)).addClass("mapster_el").css(c.canvas_style)[0];
},addShapeGroup:function(f,k,m){var j=this,h,l,g,i=this.map_data,n=f.effectiveRenderOptions(k);
if(m){a.extend(n,m);}if(k==="select"){l="static_"+f.areaId.toString();g=i.base_canvas;
}else{g=i.overlay_canvas;}j.begin(g,l);if(n.includeKeys){h=e.split(n.includeKeys);
a.each(h,function(q,p){var o=i.getDataForKey(p.toString());b(j,o,o.effectiveRenderOptions(k));
});}b(j,f,n);j.render();if(n.fade){e.fader(c.hasCanvas?g:a(g).find("._fill").not(".mapster_mask"),0,c.hasCanvas?1:n.fillOpacity,n.fadeDuration);
}}};if(c.hasCanvas){d.hex_to_decimal=function(f){return Math.max(0,Math.min(parseInt(f,16),255));
};d.css3color=function(f,g){return"rgba("+this.hex_to_decimal(f.substr(0,2))+","+this.hex_to_decimal(f.substr(2,2))+","+this.hex_to_decimal(f.substr(4,2))+","+g+")";
};d.renderShape=function(g,j,k){var h,f=j.coords(null,k);switch(j.shape){case"rect":g.rect(f[0],f[1],f[2]-f[0],f[3]-f[1]);
break;case"poly":g.moveTo(f[0],f[1]);for(h=2;h<j.length;h+=2){g.lineTo(f[h],f[h+1]);
}g.lineTo(f[0],f[1]);break;case"circ":case"circle":g.arc(f[0],f[1],f[2],0,Math.PI*2,false);
break;}};d.addAltImage=function(f,g,h,i){f.beginPath();this.renderShape(f,h);f.closePath();
f.clip();f.globalAlpha=i.altImageOpacity||i.fillOpacity;f.drawImage(g,0,0,h.owner.scaleInfo.width,h.owner.scaleInfo.height);
};d.render=function(){var h,i,j=this,g=j.masks.length,k=j.createCanvasFor(j.map_data),l=k.getContext("2d"),f=j.canvas.getContext("2d");
if(g){h=j.createCanvasFor(j.map_data);i=h.getContext("2d");i.clearRect(0,0,h.width,h.height);
a.each(j.masks,function(n,m){i.save();i.beginPath();j.renderShape(i,m.mapArea);i.closePath();
i.clip();i.lineWidth=0;i.fillStyle="#000";i.fill();i.restore();});}a.each(j.shapes,function(m,n){l.save();
if(n.options.fill){if(n.options.alt_image){j.addAltImage(l,n.options.alt_image,n.mapArea,n.options);
}else{l.beginPath();j.renderShape(l,n.mapArea);l.closePath();l.fillStyle=j.css3color(n.options.fillColor,n.options.fillOpacity);
l.fill();}}l.restore();});a.each(j.shapes.concat(j.masks),function(m,o){var n=o.options.strokeWidth===1?0.5:0;
if(o.options.stroke){l.save();l.strokeStyle=j.css3color(o.options.strokeColor,o.options.strokeOpacity);
l.lineWidth=o.options.strokeWidth;l.beginPath();j.renderShape(l,o.mapArea,n);l.closePath();
l.stroke();l.restore();}});if(g){i.globalCompositeOperation="source-out";i.drawImage(k,0,0);
f.drawImage(h,0,0);}else{f.drawImage(k,0,0);}j.active=false;return j.canvas;};d.createCanvasFor=function(f){return a('<canvas width="'+f.scaleInfo.width+'" height="'+f.scaleInfo.height+'"></canvas>')[0];
};d.clearHighlight=function(){var f=this.map_data.overlay_canvas;f.getContext("2d").clearRect(0,0,f.width,f.height);
};d.removeSelections=function(){};d.refreshSelections=function(){var f,g=this.map_data;
f=g.base_canvas;g.base_canvas=this.createVisibleCanvas(g);a(g.base_canvas).hide();
a(f).before(g.base_canvas);g.redrawSelections();a(g.base_canvas).show();a(f).remove();
};}else{e.setOpacity=function(f,g){a(f).each(function(j,h){if(typeof h.opacity!=="undefined"){h.opacity=g;
}else{a(h).css("opacity",g);}});};d.renderShape=function(l,n,g){var m=this,k,o,h,p,j,i,q,f=l.coords();
j=m.elementName?'name="'+m.elementName+'" ':"";i=g?'class="'+g+'" ':"";p='<v:fill color="#'+n.fillColor+'" class="_fill" opacity="'+(n.fill?n.fillOpacity:0)+'" /><v:stroke class="_fill" opacity="'+n.strokeOpacity+'"/>';
o=n.stroke?" strokeweight="+n.strokeWidth+' stroked="t" strokecolor="#'+n.strokeColor+'"':' stroked="f"';
k=n.fill?' filled="t"':' filled="f"';switch(l.shape){case"rect":q="<v:rect "+i+j+k+o+' style="zoom:1;margin:0;padding:0;display:block;position:absolute;left:'+f[0]+"px;top:"+f[1]+"px;width:"+(f[2]-f[0])+"px;height:"+(f[3]-f[1])+'px;">'+p+"</v:rect>";
break;case"poly":q="<v:shape "+i+j+k+o+' coordorigin="0,0" coordsize="'+m.width+","+m.height+'" path="m '+f[0]+","+f[1]+" l "+f.slice(2).join(",")+' x e" style="zoom:1;margin:0;padding:0;display:block;position:absolute;top:0px;left:0px;width:'+m.width+"px;height:"+m.height+'px;">'+p+"</v:shape>";
break;case"circ":case"circle":q="<v:oval "+i+j+k+o+' style="zoom:1;margin:0;padding:0;display:block;position:absolute;left:'+(f[0]-f[2])+"px;top:"+(f[1]-f[2])+"px;width:"+(f[2]*2)+"px;height:"+(f[2]*2)+'px;">'+p+"</v:oval>";
break;}h=a(q);a(m.canvas).append(h);return h;};d.render=function(){var g,f=this;a.each(this.shapes,function(j,h){f.renderShape(h.mapArea,h.options);
});if(this.masks.length){a.each(this.masks,function(j,h){g=e.updateProps({},h.options,{fillOpacity:1,fillColor:h.options.fillColorMask});
f.renderShape(h.mapArea,g,"mapster_mask");});}this.active=false;return this.canvas;
};d.createCanvasFor=function(g){var i=g.scaleInfo.width,f=g.scaleInfo.height;return a('<var width="'+i+'" height="'+f+'" style="zoom:1;overflow:hidden;display:block;width:'+i+"px;height:"+f+'px;"></var>')[0];
};d.clearHighlight=function(){a(this.map_data.overlay_canvas).children().remove();
};d.removeSelections=function(f){if(f>=0){a(this.map_data.base_canvas).find('[name="static_'+f.toString()+'"]').remove();
}else{a(this.map_data.base_canvas).children().remove();}};d.refreshSelections=function(){return null;
};}}(jQuery));